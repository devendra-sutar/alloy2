clusterName: ""
username: ""
prometheusUrl: ""
lokiUrl: ""
backendHost: ""
providerName: ""
tags: []
agentId: ""
apiKey: ""

kubearmor:
  enabled: true
  config:
    enableSecurity: true
    enableVisibility: true
    enablePolicy: true



apiVersion: v2
appVersion: 1.16.1
dependencies:
- condition: kyverno.enabled
  name: kyverno
  repository: https://kyverno.github.io/kyverno/
  version: 3.2.6
- condition: kubearmor.enabled
  name: kubearmor-operator
  repository: https://kubearmor.github.io/charts
  version: 1.6.4
- condition: nfd.enabled
  name: node-feature-discovery
  repository: https://kubernetes-sigs.github.io/node-feature-discovery/charts
  version: 0.18.3
description: A Helm chart for Kubernetes
name: onboarding-agent
type: application
version: 0.1.1


{{/*
Validate that required values are supplied via --set (or values file)
*/}}
{{- define "requiredValues" -}}
  {{- if not .Values.clusterName -}}
    {{- fail "clusterName is REQUIRED. Use --set clusterName=..." -}}
  {{- end -}}
  {{- if not .Values.username -}}
    {{- fail "username is REQUIRED. Use --set username=..." -}}
  {{- end -}}
  {{- if not .Values.prometheusUrl -}}
    {{- fail "prometheusUrl is REQUIRED. Use --set prometheusUrl=..." -}}
  {{- end -}}
  {{- if not .Values.lokiUrl -}}
    {{- fail "lokiUrl is REQUIRED. Use --set lokiUrl=..." -}}
  {{- end -}}
  {{- if not .Values.backendHost -}}
    {{- fail "backendHost is REQUIRED. Use --set backendHost=..." -}}
  {{- end -}}
  {{- if not .Values.providerName -}}
    {{- fail "providerName is REQUIRED. Use --set providerName=..." -}}
  {{- end -}}
  {{- if not .Values.agentId -}}
    {{- fail "agentId is REQUIRED. Use --set agentId=..." -}}
  {{- end -}}
  {{- if not .Values.apiKey -}}
    {{- fail "apiKey is REQUIRED. Use --set apiKey=..." -}}
  {{- end -}}
  {{- if not .Values.tags -}}
    {{- fail "tags is REQUIRED. Use --set tags='{prod,dev}'" -}}
  {{- end -}}
{{- end -}}


apiVersion: v1
kind: Namespace
metadata:
  name: onboard


apiVersion: operator.kubearmor.com/v1
kind: KubeArmorConfig
metadata:
  labels:
    app.kubernetes.io/name: kubearmorconfig
    app.kubernetes.io/instance: kubearmorconfig-sample
    app.kubernetes.io/part-of: kubearmoroperator
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/created-by: kubearmoroperator
  name: kubearmorconfig-default
  namespace: onboard
spec:
  defaultCapabilitiesPosture: audit
  defaultFilePosture: audit
  defaultNetworkPosture: audit
  defaultVisibility: process,network
  enableStdOutLogs: false
  enableStdOutAlerts: false
  enableStdOutMsgs: false
  seccompEnabled: false
  alertThrottling: true
  maxAlertPerSec: 10
  throttleSec: 30
  kubearmorImage:
    image: kubearmor/kubearmor:stable
    imagePullPolicy: Always
  kubearmorInitImage:
    image: kubearmor/kubearmor-init:stable
    imagePullPolicy: Always
  kubearmorRelayImage:
    image: kubearmor/kubearmor-relay-server
    imagePullPolicy: Always
  kubearmorControllerImage:
    image: kubearmor/kubearmor-controller
    imagePullPolicy: Always



{{/* ======================================== */}}
{{/* Validate required values */}}
{{- include "requiredValues" . -}}
{{- /* ======================================== */}}
{{- /* 0. ServiceAccount - Onboarding */}}
{{- /* ======================================== */}}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: onboarding-sa																			
  namespace: default
---
{{- /* ======================================== */}}
{{- /* 1. ClusterRoleBinding - Onboarding (cluster-admin) */}}
{{- /* ======================================== */}}
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: onboarding-sa-cluster-admin
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
  - kind: ServiceAccount
    name: onboarding-sa
    namespace: default
---
{{- /* ======================================== */}}
{{- /* 2. ConfigMap – Onboarding Job */}}
{{- /* ======================================== */}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: onboarding-config
  namespace: default
data:
  CLUSTER_NAME: "{{ .Values.clusterName }}"
  USERNAME: "{{ .Values.username }}"
  PROMETHEUS_URL: "{{ .Values.prometheusUrl }}"
  LOKI_URL: "{{ .Values.lokiUrl }}"
  API_HOST: "{{ .Values.backendHost }}"
---
{{- /* ======================================== */}}
{{- /* 3. Job – k8s-onboarding-job */}}
{{- /* ======================================== */}}
apiVersion: batch/v1
kind: Job
metadata:
  name: k8s-onboarding-job
  namespace: default
  labels:
    app: onboarding
spec:
  backoffLimit: 1
  template:
    metadata:
      labels:
        app: onboarding
    spec:
      serviceAccountName: onboarding-sa
      restartPolicy: Never
      tolerations:
        - key: "CriticalAddonsOnly"
          operator: "Exists"
          effect: "NoSchedule"
      containers:
        - name: deploy
          image: os3infotech/monitoring-stack:v1.0.0 
          imagePullPolicy: Always
          envFrom:
            - configMapRef:
                name: onboarding-config
          args:
            - "{{ .Values.clusterName }}"
            - "{{ .Values.username }}"
            - "{{ .Values.prometheusUrl }}"
            - "{{ .Values.lokiUrl }}"
            - "{{ .Values.backendHost }}"
---
{{- /* ======================================== */}}
{{- /* 4. ServiceAccount – KubeSage Agent */}}
{{- /* ======================================== */}}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: kubesage-agent
  namespace: default
---
{{- /* ======================================== */}}
{{- /* 5. ConfigMap – Agent Env */}}
{{- /* ======================================== */}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: agent-env
  namespace: default
data:
  AGENT_ID: "{{ .Values.agentId }}"
  API_KEY: "{{ .Values.apiKey }}"
  CLUSTER_NAME: "{{ .Values.clusterName }}"
  PROVIDER_NAME: "{{ .Values.providerName }}"
  TAGS_JSON: '{{ toJson .Values.tags }}'
  BACKEND_URL: "https://{{ .Values.backendHost }}/api/v2.0/onboard"
  BACKEND_WS_URL: "wss://{{ .Values.backendHost }}/api/v2.0/ws"
  PORT: "9000"
  SKIP_TLS_VERIFY: "true"
  DEBUG: "true"
  LOG_LEVEL: "INFO"
---
{{- /* ======================================== */}}
{{- /* 6. ClusterRole – KubeSage Agent */}}
{{- /* ======================================== */}}
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: kubesage-agent-role
rules:
- apiGroups: [""]
  resources: ["nodes", "namespaces", "pods", "services", "persistentvolumes", "configmaps", "secrets", "serviceaccounts", "events"]
  verbs: ["*"]
- apiGroups: ["apps"]
  resources: ["deployments", "replicasets", "statefulsets", "daemonsets"]
  verbs: ["*"]
- apiGroups: ["batch"]
  resources: ["jobs", "cronjobs"]
  verbs: ["*"]
- apiGroups: ["metrics.k8s.io"]
  resources: ["pods", "nodes"]
  verbs: ["*"]
- apiGroups: ["rbac.authorization.k8s.io"]
  resources: ["roles", "rolebindings", "clusterroles", "clusterrolebindings"]
  verbs: ["*"]
- apiGroups: ["networking.k8s.io", "extensions"]
  resources: ["ingresses"]
  verbs: ["*"]
- apiGroups: ["kyverno.io"]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["security.kubearmor.com"]
  resources: ["*"]
  verbs: ["*"]
---
{{- /* ======================================== */}}
{{- /* 7. ClusterRoleBinding – KubeSage Agent */}}
{{- /* ======================================== */}}
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kubesage-agent-binding
subjects:
- kind: ServiceAccount
  name: kubesage-agent
  namespace: default
roleRef:
  kind: ClusterRole
  name: kubesage-agent-role
  apiGroup: rbac.authorization.k8s.io
---
{{- /* ======================================== */}}
{{- /* 8. Deployment – my-agent */}}
{{- /* ======================================== */}}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-agent
  namespace: default
  labels:
    app: my-agent
spec:
  replicas: 1
  selector:
    matchLabels:
      app: my-agent
  template:
    metadata:
      labels:
        app: my-agent
    spec:
      serviceAccountName: kubesage-agent
      tolerations:
        - key: "node.kubernetes.io/disk-pressure"
          operator: "Exists"
          effect: "NoSchedule"
      containers:
      - name: agent
        image: os3infotech/agent-stack:v1.0.0 
        imagePullPolicy: Always
        ports:
        - containerPort: 9000
        envFrom:
        - configMapRef:
            name: agent-env
---
{{- /* ======================================== */}}
{{- /* 9. Service – NodePort */}}
{{- /* ======================================== */}}
apiVersion: v1
kind: Service
metadata:
  name: my-agent-svc
  namespace: default
spec:
  selector:
    app: my-agent
  ports:
  - protocol: TCP
    port: 9000
    targetPort: 9000
    nodePort: 31245
  type: NodePort



